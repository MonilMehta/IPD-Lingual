<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        .detection-result {
            margin-left: 20px;
            color: #0066cc;
        }
        .coordinates {
            color: #888;
            margin-left: 10px;
            font-size: 0.9em;
        }
        .detection-box {
            position: absolute;
            border: 2px solid lime;
            pointer-events: none;
        }
        .detection-label {
            position: absolute;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            white-space: nowrap;
        }
        #annotatedImage {
            position: relative;
            display: inline-block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>WebSocket Client Test</h1>
    
    <div>
        <h3>Image Preview:</h3>
        <div id="annotatedImage">
            <img id="imagePreview" src="" alt="No image selected">
        </div>
        <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageSelect(this)">
    </div>
    
    <h3>Messages:</h3>
    <div id="messages"></div>

    <script>
        let detections = [];
        
        function connectWebSocket() {
        }

        function handleImageSelect(input) {
        }

        function sendCurrentImage() {
        }
        
        function loadAndSendTestImage() {
        }
        
        let videoStream = null;
        
        async function captureAndSendImage() {
        }

        function setLanguage(lang) {
        }

        function stopDetection() {
        }

        socket.addEventListener('message', (event) => {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'detection' && data.results) {
                    detections = data.results;
                    logMessage(`📩 Detected ${data.results.length} objects:`);
                    
                    clearDetectionBoxes();
                    
                    data.results.forEach(result => {
                        const percent = (result.confidence*100).toFixed(1);
                        const box = result.box;
                        const coordStr = `[${box[0]},${box[1]}] to [${box[2]},${box[3]}]`;
                        
                        logMessage(`   - ${result.label} (${result.translated}): ${percent}% at ${coordStr}`, true);
                        
                        drawDetectionBox(result);
                    });
                } else if (data.type === 'error') {
                    logMessage(`⚠️ Error: ${data.message}`);
                } else {
                    logMessage(`📩 ${data.type}: ${data.message || JSON.stringify(data)}`);
                }
            } catch (e) {
                logMessage(`📩 Raw message: ${event.data}`);
            }
        });

        function clearDetectionBoxes() {
            const container = document.getElementById('annotatedImage');
            const existingBoxes = container.querySelectorAll('.detection-box, .detection-label');
            existingBoxes.forEach(box => box.remove());
        }
        
        function drawDetectionBox(detection) {
            const container = document.getElementById('annotatedImage');
            const img = document.getElementById('imagePreview');
            
            if (img.naturalWidth === 0) return;
            
            const scaleX = img.width / 640;
            const scaleY = img.height / 480;
            
            const [x1, y1, x2, y2] = detection.box;
            
            const box = document.createElement('div');
            box.className = 'detection-box';
            box.style.left = `${x1 * scaleX}px`;
            box.style.top = `${y1 * scaleY}px`;
            box.style.width = `${(x2 - x1) * scaleX}px`;
            box.style.height = `${(y2 - y1) * scaleY}px`;
            
            const label = document.createElement('div');
            label.className = 'detection-label';
            label.textContent = `${detection.translated} (${(detection.confidence*100).toFixed(1)}%)`;
            label.style.left = `${x1 * scaleX}px`;
            label.style.top = `${(y1 * scaleY) - 20}px`;
            
            container.appendChild(box);
            container.appendChild(label);
        }

        function logMessage(message, isDetection = false) {
            const msgDiv = document.getElementById('messages');
            const time = new Date().toLocaleTimeString();
            const messageClass = isDetection ? 'detection-result' : 'message';
            
            let formattedMessage = message;
            
            if (isDetection && message.includes('at [')) {
                const parts = message.split(' at ');
                formattedMessage = `${parts[0]}<span class="coordinates">${parts[1]}</span>`;
            }
            
            msgDiv.innerHTML = `<div class="${messageClass}">[${time}] ${formattedMessage}</div>` + msgDiv.innerHTML;
            console.log(message);
        }
    </script>
</body>
</html>
